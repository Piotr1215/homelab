@startuml
!include <office/Servers/database_server>
!include <office/Servers/application_server>
!include <office/Devices/router>

skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 50

' Internet entry point
cloud "Internet" as internet

' Main container
rectangle "192.168.178.0/24 - Physical Home Network" #FFE5E5 {

  ' Infrastructure layer
  rectangle "Infrastructure (.1-.109)" #FFEBEE {
    node "<$router>\n.1\nRouter" as router
    database "<$database_server>\n.60\nNAS" as nas
    node "<$application_server>\n.75\nProxmox-1" as pve1
    node "<$application_server>\n.109\nProxmox-2" as pve2
  }

  cloud ".120-.200\nDHCP\n81 IPs" as dhcp

  storage ".201-.254\nReserved\n54 IPs" as reserved

  ' Kubernetes cluster
  rectangle "Kubernetes Cluster" #FFF8E1 {

    ' Nodes layer
    rectangle "Nodes (.87-.111)" #FFF3E0 {
      node ".87\nkube-main" as main
      node ".88\nworker1" as w1
      node ".107\nworker3" as w3
      node ".111\nworker4" as w4
    }

    ' LoadBalancer IPs - ENTRY POINT to cluster
    rectangle "LoadBalancer IPs (.90-.119)" #E8F5E9 {
      component ".90 Prometheus" as lb90
      component ".91 Ingress" as lb91
      component ".93 Homepage" as lb93
      component ".96 Grafana" as lb96
      component ".98 ArgoCD" as lb98
      component ".99 Forgejo" as lb99
      component ".105 Longhorn" as lb105
      component ".106 Falco" as lb106
    }

    ' Internal networks (parallel)
    rectangle "Service Network\n10.233.0.0/18" #BEEFC9 {
      component "ClusterIP\nServices" as svcs
    }

    rectangle "Pod Network\n10.233.64.0/18" #E3F2FD {
      component "Pods" as pods
    }
  }
}

' Flow: Internet -> Infrastructure
internet --> router : "1"

' Flow: Infrastructure -> Physical devices
router --> pve1 : "2"
router --> pve2 : "2"
router --> nas : "2"

' Flow: Proxmox hosts VMs
pve1 --> main : "3"
pve1 --> w1 : "3"
pve2 --> w3 : "3"
pve2 --> w4 : "3"

' Flow: External request -> LoadBalancer (one line to the box)
router --> "LoadBalancer IPs (.90-.119)" : "4"

' Flow: LoadBalancer -> Service (box to box)
"LoadBalancer IPs (.90-.119)" --> "Service Network\n10.233.0.0/18" : "5"

' Flow: Service -> Pod (box to box)
"Service Network\n10.233.0.0/18" --> "Pod Network\n10.233.64.0/18" : "6"

' Storage connection
nas ..> main : "Longhorn\nbackups"

note right of "LoadBalancer IPs (.90-.119)"
  External traffic flow:
  Internet → Router → LoadBalancer IP
  → ClusterIP Service → Pod
end note

@enduml
