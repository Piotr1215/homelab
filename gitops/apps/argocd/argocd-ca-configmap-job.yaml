apiVersion: batch/v1
kind: Job
metadata:
  name: create-argocd-backend-ca-cm
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      serviceAccountName: argocd-ca-job
      containers:
      - name: create-ca-configmap
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          # Extract CA cert from running ArgoCD server
          kubectl exec -n argocd deploy/argocd-server -- sh -c "openssl s_client -connect localhost:8080 -showcerts </dev/null 2>/dev/null | sed -n '/BEGIN CERTIFICATE/,/END CERTIFICATE/p'" > /tmp/ca.crt

          # Create or update ConfigMap
          kubectl create configmap argocd-backend-ca-cm \
            --from-file=ca.crt=/tmp/ca.crt \
            --dry-run=client -o yaml | kubectl apply -f -
      restartPolicy: OnFailure
  backoffLimit: 3
