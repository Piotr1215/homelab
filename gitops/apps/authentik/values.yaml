# Authentik 2025.10.1 - Homelab Configuration
# Reference: research-authentik-homelab-2025-11-15.md

global:
  deploymentAnnotations:
    reloader.stakater.com/auto: "true"

authentik:
  log_level: info
  # Secret key will be provided via ExternalSecret
  secret_key: ""
  error_reporting:
    enabled: true

  postgresql:
    # PostgreSQL password will be provided via ExternalSecret
    password: ""

  # Email configuration (optional - can be configured later)
  email:
    host: ""
    port: 587
    username: ""
    password: ""
    use_tls: false
    from: ""

server:
  enabled: true
  name: server
  replicas: 2

  # Inject secret key from ExternalSecret
  envFrom:
    - secretRef:
        name: authentik-secret-key

  # Inject PostgreSQL password
  env:
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-postgresql
          key: password

  service:
    type: LoadBalancer
    annotations:
      metallb.universe.tf/loadBalancerIPs: "192.168.178.99"
    servicePortHttp: 80
    servicePortHttps: 443

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

  # Ingress disabled - using LoadBalancer
  ingress:
    enabled: false

worker:
  enabled: true
  replicas: 1

  # Inject secret key from ExternalSecret
  envFrom:
    - secretRef:
        name: authentik-secret-key

  # Inject PostgreSQL password
  env:
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-postgresql
          key: password

  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Enable built-in PostgreSQL (Bitnami chart)
postgresql:
  enabled: true
  image:
    registry: docker.io
    repository: library/postgres
    tag: "18-alpine"

  auth:
    username: authentik
    database: authentik
    # Password will be set via existingSecret from ExternalSecret
    existingSecret: authentik-postgresql
    secretKeys:
      adminPasswordKey: password
      userPasswordKey: password

  primary:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: longhorn

    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

    # Increased max_connections for 2025.10 (Redis removed)
    extendedConfiguration: |
      max_connections = 500

# Redis removed in 2025.10
redis:
  enabled: false
