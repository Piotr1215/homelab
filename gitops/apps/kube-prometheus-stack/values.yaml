namespaceOverride: prometheus

kubeEtcd:
  enabled: false

kube-state-metrics:
  namespaceOverride: prometheus

prometheus-node-exporter:
  namespaceOverride: prometheus

prometheus:
  service:
    type: LoadBalancer
    annotations:
      metallb.universe.tf/loadBalancerIPs: "192.168.178.90"
  prometheusSpec:
    enableRemoteWriteReceiver: true
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: local-path
          resources:
            requests:
              storage: 10Gi
    resources:
      requests:
        cpu: 200m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi

grafana:
  namespaceOverride: prometheus
  defaultDashboardsEnabled: true
  initChownData:
    enabled: false
  service:
    type: LoadBalancer
    annotations:
      metallb.universe.tf/loadBalancerIPs: "192.168.178.96"
  persistence:
    enabled: true
    size: 1Gi
    storageClassName: local-path
  securityContext:
    fsGroup: 472
    runAsUser: 472
    runAsNonRoot: true
  env:
    GF_INSTALL_PLUGINS: grafana-pyroscope-datasource,grafana-llm-app
  additionalDataSources:
    - name: Pyroscope
      type: grafana-pyroscope-datasource
      access: proxy
      url: http://pyroscope.pyroscope.svc.cluster.local:4040
      editable: true
      isDefault: false
      jsonData:
        minStep: '15s'
  sidecar:
    datasources:
      enabled: true
      adminUser: admin
      adminPassword:
        existingSecret: grafana-admin-token
        key: token

alertmanager:
  enabled: true
  service:
    type: LoadBalancer
    annotations:
      metallb.universe.tf/loadBalancerIPs: "192.168.178.91"
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: local-path
          resources:
            requests:
              storage: 1Gi
    secrets:
      - ntfy-webhook-url
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'default'
      routes:
        # Critical alerts - send immediately
        - matchers:
            - severity = critical
          receiver: ntfy-critical
          group_wait: 0s
          repeat_interval: 4h
          continue: true
        # Warning alerts
        - matchers:
            - severity = warning
          receiver: ntfy-warning
          group_wait: 30s
          repeat_interval: 12h
        # Storage alerts
        - matchers:
            - alertname =~ "PersistentVolume.*|.*DiskPressure"
          receiver: ntfy-storage
          repeat_interval: 12h
        # Backup alerts
        - matchers:
            - alertname =~ "VeleroBackup.*|VaultSnapshot.*"
          receiver: ntfy-backup
          repeat_interval: 12h
        # VCluster MCP alerts
        - matchers:
            - alertname = VClusterMCPServerUsed
          receiver: ntfy-vcluster-mcp
          group_by: ['pod']
          group_wait: 5s
          repeat_interval: 5m
        # Watchdog (health check - silence)
        - matchers:
            - alertname = "Watchdog"
          receiver: "null"
    receivers:
      - name: 'null'
      - name: 'default'
        webhook_configs:
          - url: 'http://ntfy-alertmanager.ntfy-alertmanager.svc.cluster.local:8080'
            send_resolved: true
            http_config:
              basic_auth:
                username: alertmanager
                password: changeme
      - name: 'ntfy-critical'
        webhook_configs:
          - url: 'http://ntfy-alertmanager.ntfy-alertmanager.svc.cluster.local:8080'
            send_resolved: true
            http_config:
              basic_auth:
                username: alertmanager
                password: changeme
      - name: 'ntfy-warning'
        webhook_configs:
          - url: 'http://ntfy-alertmanager.ntfy-alertmanager.svc.cluster.local:8080'
            send_resolved: true
            http_config:
              basic_auth:
                username: alertmanager
                password: changeme
      - name: 'ntfy-storage'
        webhook_configs:
          - url: 'http://ntfy-alertmanager.ntfy-alertmanager.svc.cluster.local:8080'
            send_resolved: true
            http_config:
              basic_auth:
                username: alertmanager
                password: changeme
      - name: 'ntfy-backup'
        webhook_configs:
          - url: 'http://ntfy-alertmanager.ntfy-alertmanager.svc.cluster.local:8080'
            send_resolved: true
            http_config:
              basic_auth:
                username: alertmanager
                password: changeme
      - name: 'ntfy-vcluster-mcp'
        webhook_configs:
          - url_file: /etc/alertmanager/secrets/ntfy-webhook-url/url
            send_resolved: true
    inhibit_rules:
      - source_matchers:
          - severity = critical
        target_matchers:
          - severity = warning
        equal: ['alertname', 'namespace', 'pod']
    templates:
      - /etc/alertmanager/config/*.tmpl
