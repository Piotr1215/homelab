---
# Allow ingress controller to access services
# Nginx ingress controller needs to route traffic from external LoadBalancer
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-nginx-ingress
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: nginx
  policyTypes:
  - Ingress
  ingress:
  - ports:  # Allow from anywhere (external + internal traffic)
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
---
# Allow traffic to web-app from nginx ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-app-ingress
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: web-app
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 80
---
# Allow traffic to homepage from anywhere (it's a dashboard with LoadBalancer)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-homepage-ingress
  namespace: homepage
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: homepage
  policyTypes:
  - Ingress
  ingress:
  - ports:  # Allow from anywhere (external LoadBalancer traffic)
    - protocol: TCP
      port: 3000
---
# Allow traffic to MinIO from anywhere (LoadBalancer for S3 API and Console)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-minio-ingress
  namespace: minio
spec:
  podSelector:
    matchLabels:
      app: minio
  policyTypes:
  - Ingress
  ingress:
  - ports:  # Allow from anywhere (external LoadBalancer + internal services like Longhorn)
    - protocol: TCP
      port: 9000  # S3 API
    - protocol: TCP
      port: 9001  # Console
---
# Allow traffic to Forgejo from anywhere (LoadBalancer for web UI and SSH)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-forgejo-ingress
  namespace: git-mirror
spec:
  podSelector:
    matchLabels:
      app: forgejo
  policyTypes:
  - Ingress
  ingress:
  - ports:  # Allow from anywhere (external LoadBalancer traffic)
    - protocol: TCP
      port: 3000
    - protocol: TCP
      port: 22  # SSH for git operations
---
# Allow traffic to ArgoCD server from anywhere (LoadBalancer)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-argocd-server-ingress
  namespace: argocd
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: argocd-server
  policyTypes:
  - Ingress
  ingress:
  - ports:  # Allow from anywhere (external LoadBalancer traffic)
    - protocol: TCP
      port: 8080  # HTTP
    - protocol: TCP
      port: 8083  # GRPC
